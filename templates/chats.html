<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats</title>
    <link rel="stylesheet" href="static/css/styles.css">
</head>

<body>
    <!--  <div id="menu-overlay"></div>   -->
    <div class="container">
        <div class="slide-menu">
            <div class="slide-menu-header">
                <img src="profile-picture.jpg" alt="Profile Picture" id="profile-picture">
                <span id="username">Username</span>
            </div>
            <div class="slide-menu-body">
                <button id="add-contact-slide">Add Contact</button>
                <button id="create-group-btn">Create Group</button>
                <button id="settings-btn">Settings</button>
            </div>
            <div class="slide-menu-footer">
                <button id="logout-slide-btn">Log Out</button>
            </div>
        </div>
        <!-- Sidebar Section -->
        <div class="sidebar">
            <button id="toggle-slide-menu">â˜°</button>
            <button id="add-contact-btn">Add Contact</button>
            <div id="contact-list">
                <!-- Contacts will be dynamically loaded here -->
            </div>
        </div>
        <!-- Chat Section -->
        <div class="chat-container">
            <div id="chat-header">
                <span id="contact-name">Select a contact to chat</span>
                <button id="logout-btn">Logout</button>
            </div>
            <div id="chat-messages">
                <!-- Chat messages will be displayed here -->
            </div>
            <div id="chat-input">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>


    <div id="add-contact-popup" class="popup">
        <h3>Add Contact</h3>
        <input type="text" id="contact-username" placeholder="Enter username of contact" />
        <button id="confirm-add-contact-btn">Add Contact</button>
        <button id="cancel-add-contact-btn">Cancel</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const loggedInUserId = "{{ user_uuid }}";
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

            const addContactBtn = document.getElementById('add-contact-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const sendBtn = document.getElementById('send-btn');
            const addContactPopup = document.getElementById('add-contact-popup');
            const confirmAddContactBtn = document.getElementById('confirm-add-contact-btn');
            const cancelAddContactBtn = document.getElementById('cancel-add-contact-btn');
            const contactList = document.getElementById('contact-list');
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const contactName = document.getElementById('contact-name');

            // Toggle slide menu functionality
            const slideMenu = document.querySelector('.slide-menu');
            const container = document.querySelector('.container');
            const overlay = document.getElementById('menu-overlay');
            const toggleButton = document.getElementById('toggle-slide-menu');

            let activeContactId = null;
            let activeContactName = null;

            // Show add contact popup
            addContactBtn.addEventListener("click", () => {
                addContactPopup.style.display = "block";
            });

            // Hide add contact popup
            cancelAddContactBtn.addEventListener("click", () => {
                addContactPopup.style.display = "none";
            });

            // Confirm add contact
            confirmAddContactBtn.addEventListener("click", () => {
                const contactUsername = document.getElementById('contact-username').value.trim();
                if (contactUsername) {
                    fetch('/add_contact', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: contactUsername })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                fetchContacts(); // Refresh contact list
                                addContactPopup.style.display = "none"; // Close popup
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch(err => console.error("Error adding contact:", err));
                }
            });

            // Update contact list
            function fetchContacts() {
                fetch('/get_contacts')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateContactList(data.contacts);
                        } else {
                            alert("Error loading contacts.");
                        }
                    })
                    .catch(err => console.error("Error fetching contacts:", err));
            }

            function updateContactList(contacts) {
                contactList.innerHTML = ''; // Clear existing list
                contacts.forEach(contact => {
                    const contactItem = document.createElement('div');
                    contactItem.classList.add('contact-item', 'flex'); // Add "flex" for layout

                    // Add profile picture
                    const profilePicture = document.createElement('img');
                    profilePicture.classList.add('profile-picture');
                    profilePicture.src = contact.profile_picture || 'default-profile.png'; // Default profile picture
                    profilePicture.alt = 'Profile Picture';
                    profilePicture.width = 20;
                    profilePicture.height = 20;

                    // Add chat-info container
                    const chatInfo = document.createElement('div');
                    chatInfo.classList.add('chat-info');

                    // Add contact name (h4)
                    const contactName = document.createElement('h4');
                    contactName.innerText = contact.chat_name;

                    // Add latest message (h5)
                    const latestMessage = document.createElement('h5');
                    latestMessage.innerText = contact.latest_message || 'No messages yet'; // Placeholder if no message

                    // Append elements to chat-info
                    chatInfo.appendChild(contactName);
                    chatInfo.appendChild(latestMessage);

                    // Append elements to contact-item
                    contactItem.appendChild(profilePicture);
                    contactItem.appendChild(chatInfo);

                    // Add click event to load chat
                    contactItem.addEventListener('click', () => {
                        loadChat(contact.chat_id, contact.chat_name);
                    });

                    contactList.appendChild(contactItem);
                });
            }

            // Load chat messages
            function loadChat(contactId, contactUsername) {
                activeContactId = contactId;
                activeContactName = contactUsername;

                contactName.innerText = contactUsername; // Update chat header
                chatMessages.innerHTML = ''; // Clear existing messages

                // Join the selected chat room
                socket.emit('join_chat', { chat_id: contactId });

                // Fetch previous chat messages
                fetch(`/get_messages/${contactId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.messages.forEach(msg => {
                                displayMessage(msg.content, msg.sender_id === "{{ user_uuid }}" ? "self" : "other", msg.timestamp, msg.status);
                            });
                        } else {
                            console.error("Error loading messages:", data.message);
                        }
                    })
                    .catch(err => console.error("Error fetching messages:", err));
            }

            // Display a single message in the chat
            function displayMessage(message, senderType, timestamp, status) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', senderType === "self" ? 'self-message' : 'other-message');

                const timestampDiv = document.createElement('span');
                timestampDiv.classList.add('timestamp');
                timestampDiv.innerText = timestamp;

                const statusDiv = document.createElement('span');
                statusDiv.classList.add('status');
                statusDiv.innerText = status; // e.g., "sent", "read"

                messageDiv.innerHTML = `${message} <div>${timestampDiv.outerHTML} ${statusDiv.outerHTML}</div>`;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the latest message
            }

            // Send message
            sendBtn.addEventListener("click", () => {
                const message = messageInput.value.trim();
                if (message && activeContactId) {
                    socket.emit('send_message', {
                        chat_id: activeContactId,
                        content: message,
                        sender_id: "{{ user_uuid }}",  // Your user ID
                        receiver_id: activeContactId  // Assuming activeContactId is the ID of the user you are chatting with
                    });

                    // Display the message immediately (optimistic UI update)
                    displayMessage(message, "self", new Date().toISOString(), "sent");
                    messageInput.value = '';
                }
            });

            // Receive real-time messages
            socket.on('receive_message', (data) => {
                if (data.chat_id === activeContactId) {
                    // Check if the received message is from the active contact
                    if (data.sender_id !== "{{ user_uuid }}") { // Only display if it's not from the current user
                        displayMessage(data.content, "other", data.timestamp, data.status);
                    }
                } else {
                    console.log(`New message received in another chat: ${data.chat_id}`);
                }
            });

            // Logout functionality
            logoutBtn.addEventListener("click", () => {
                fetch('/logout')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/';
                        }
                    })
                    .catch(err => console.error("Error logging out:", err));
            });

            // Toggle slide menu
            toggleButton.addEventListener('click', () => {
                const isActive = slideMenu.classList.contains('active');
                slideMenu.classList.toggle('active', !isActive); // Toggle menu
            });

            /*
            
            
                        // Close slide menu when clicking outside
                        overlay.addEventListener('click', () => {
                            slideMenu.classList.remove('active');  // Hide menu
                            container.classList.remove('blur');   // Remove blur effect
                            overlay.classList.remove('active');  // Hide overlay
                        });
            */
            // Load contacts on page load
            fetchContacts();

        });
    </script>
    <script>
        $(document).ready(function () {
            const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

            // Refresh messages dynamically using AJAX
            function fetchMessages(chatId) {
                $.ajax({
                    url: `/get_messages/${chatId}`,
                    type: "GET",
                    success: function (data) {
                        if (data.success) {
                            updateMessages(data.messages);
                        }
                    },
                    error: function () {
                        alert("Failed to fetch messages.");
                    }
                });
            }

            // Update messages dynamically in the DOM
            function updateMessages(messages) {
                const chatMessages = $('#chat-messages');
                chatMessages.empty(); // Clear current messages
                messages.forEach(msg => {
                    const senderType = msg.sender_id === loggedInUserId ? 'self' : 'other';
                    const messageElement = `
                        <div class="message ${senderType}-message">
                            <p>${msg.content}</p>
                            <span class="timestamp">${msg.timestamp}</span>
                        </div>`;
                    chatMessages.append(messageElement);
                });
            }

            // Send a new message
            $('#send-btn').on('click', function () {
                const messageInput = $('#message-input');
                const message = messageInput.val().trim();
                if (message && activeContactId) {
                    socket.emit('send_message', {
                        chat_id: activeContactId,
                        content: message,
                        sender_id: loggedInUserId
                    });
                    messageInput.val(''); // Clear input field
                }
            });

        });
    </script>
</body>

</html>